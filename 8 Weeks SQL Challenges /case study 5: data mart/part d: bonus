
DROP TABLE IF EXISTS before_after;
    Create table before_after(
    select *, 
    case when week_date < '2020-06-15' then 'before' else 'after' end as new_packaging 
    from clean_weekly_sales);

with cte as (
select *, dense_rank()over(order by week_number desc) ranking 
from before_after  
where new_packaging = 'before'
union
select *, dense_rank()over(order by week_number) ranking 
from before_after  
where new_packaging = 'after')
select week_date, ranking, region, platform, age_band, demographic, customer_type,new_packaging, 

sum(sales)over(partition by region,week_number,new_packaging)region_sum, sum(sales)over(partition by platform,week_number,new_packaging)platform_sum,sum(sales)over(partition by age_band,week_number,new_packaging)age_band_sum,sum(sales)over(partition by demographic,week_number,new_packaging)demographic_sum, sum(sales)over(partition by customer_type,week_number,new_packaging)customer_type_sum
from cte
where ranking between 1 and 12
