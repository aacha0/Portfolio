-- What is the unique count and total amount for each transaction type?
select txn_type, sum(txn_amount) total_amount,count(*) cnt_transaction
from customer_transactions 
group by txn_type ;

-- What is the average total historical deposit counts and amounts for all customers?
with cte as (
select count(*)count, avg(txn_amount) avg_total
from customer_transactions 
where txn_type = 'deposit'
group by customer_id)
select 
round(avg(count),2) avg_count,
round(avg(avg_total),2) avg_total
from cte ;
-- For each month - how many Data Bank customers make more than 1 deposit and either 1 purchase or 1 withdrawal in a single month?
with cte as(
  select month(txn_date) month, customer_id, count(customer_id) 
  from customer_transactions
  where txn_type = 'deposit'
  group by customer_id, month 
  having count(*) >1 
  order by month, customer_id),
  cte1 as(
    select customer_id, month(txn_date) month, count(*)
    from customer_transactions
    where (customer_id,month(txn_date)) in (select customer_id, month from cte) and txn_type = 'purchase'
    group by customer_id, month 
    having count(*) =1 
    order by month, customer_id),
  cte2 as(
    select customer_id, month(txn_date) month, count(*)
    from customer_transactions
    where (customer_id,month(txn_date)) in (select customer_id, month from cte) and txn_type = 'withdrawal'
    group by customer_id, month 
    having count(*) =1 
    order by month, customer_id),
    cte3 as (
      select * from cte1
      union -- using union instead of union all to avoid duplicate entries
      select * from cte2 )
select month, count(*)
from cte3 
group by month 
order by month ;
                                                                               
                                                                                



-- What is the closing balance for each customer at the end of the month?
-- What is the percentage of customers who increase their closing balance by more than 5%?
