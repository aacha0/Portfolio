

---

**Query #1**

    DROP TABLE IF EXISTS before_after;

There are no results to be displayed.

---
**Query #2**

    Create table before_after(
    select *, 
    case when week_date < '2020-06-15' then 'before' else 'after' end as new_packaging 
    from clean_weekly_sales);

There are no results to be displayed.

---
**Query #3**

    with cte as( 
      select week_date, sum(transactions) transactions, sum(sales) sales, dense_rank()over(order by week_date desc) ranking, 'before' as new_packaging
      from before_after
      where new_packaging = 'before'
      group by week_date
      union 
       select week_date, sum(transactions) transactions, sum(sales) sales, dense_rank()over(order by week_date) ranking,'after' as new_packaging
      from before_after
      where new_packaging = 'after'
      group by week_date),
      cte1 as (
        select sum(sales) sales, new_packaging 
      from cte 
      where ranking between 1 and 4
      group by new_packaging)
      
    select 
    max(case when new_packaging = 'after' then sales else null end) - max(case when new_packaging = 'before' then sales else null end) as difference, 
    round(100*((max(case when new_packaging = 'after' then sales else null end) - max(case when new_packaging = 'before' then sales else null end))/max(case when new_packaging = 'before' then sales else null end)),2) percentage_diff
    from cte1 ;

| difference | percentage_diff |
| ---------- | --------------- |
| -26884188  | -1.15           |

---
**Query #4**

    with cte as( 
      select week_date, sum(transactions) transactions, sum(sales) sales, dense_rank()over(order by week_date desc) ranking, 'before' as new_packaging
      from before_after
      where new_packaging = 'before'
      group by week_date
      union 
       select week_date, sum(transactions) transactions, sum(sales) sales, dense_rank()over(order by week_date) ranking,'after' as new_packaging
      from before_after
      where new_packaging = 'after'
      group by week_date),
      cte1 as (
        select sum(sales) sales, new_packaging 
      from cte 
      where ranking between 1 and 12
      group by new_packaging)
      
    select 
    max(case when new_packaging = 'after' then sales else null end) - max(case when new_packaging = 'before' then sales else null end) as difference, 
    round(100*((max(case when new_packaging = 'after' then sales else null end) - max(case when new_packaging = 'before' then sales else null end))/max(case when new_packaging = 'before' then sales else null end)),2) percentage_diff
    from cte1 ;

| difference | percentage_diff |
| ---------- | --------------- |
| -152325394 | -2.14           |

---
**Query #5**

    with cte as (
      select *
      from clean_weekly_sales 
      where week_number between 21 and 28),
      cte1 as(
        select calendar_year,
        case when week_number between 21 and 24 then 'before'
        else 'after' end as periods, sum(sales) sales
        from cte
      group by calendar_year, periods
      order by calendar_year),
      cte2 as (
        select calendar_year, 
        max(case when periods = 'after' then sales else null end) - max(case when periods = 'before' then sales else null end)as difference, 
    round(100*((max(case when periods = 'after' then sales else null end) - max(case when periods = 'before' then sales else null end))/max(case when periods = 'before' then sales else null end)),2) percentage_diff
        from cte1 
        group by calendar_year
        order by calendar_year) 
        select * from cte2;

| calendar_year | difference | percentage_diff |
| ------------- | ---------- | --------------- |
| 2018          | 4102105    | 0.19            |
| 2019          | 2336594    | 0.10            |
| 2020          | -26884188  | -1.15           |

---

[View on DB Fiddle](https://www.db-fiddle.com/f/jmnwogTsUE8hGqkZv9H7E8/8)
